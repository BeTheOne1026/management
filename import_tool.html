<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç²¾å‡†å¯¼å…¥å·¥å…· - é˜²æ­¢è¯¯æ”¹æ‰‹æœºå£³</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { padding: 20px; font-family: sans-serif; background: #f5f7fa; }
        .box-card { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); }
        .step { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 20px; }
        .log-box { background: #333; color: #fff; padding: 10px; height: 350px; overflow-y: auto; font-family: monospace; border-radius: 4px; font-size: 12px; }
        .log-success { color: #67C23A; }
        .log-warn { color: #E6A23C; }
        .log-error { color: #F56C6C; }
        .log-info { color: #909399; }
        .excel-demo { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .excel-demo th, .excel-demo td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
        .excel-demo th { background: #f0f2f5; }
    </style>
</head>
<body>
<div id="app">
    <div class="box-card">
        <h2>ğŸ›¡ï¸ å®‰å…¨å¯¼å…¥å·¥å…· (åˆ†ç±»éš”ç¦»ç‰ˆ)</h2>
        <el-alert title="æœ¬å·¥å…·æ”¯æŒæŒ‰åˆ†ç±»è¿‡æ»¤ï¼Œé˜²æ­¢å°†â€˜è†œâ€™çš„é€šç”¨å…³ç³»è¯¯ç”¨åˆ°â€˜å£³â€™ä¸Šã€‚" type="success" show-icon :closable="false" style="margin-bottom:20px;"></el-alert>

        <div v-if="!currentUser" class="step">
            <h3>1. ç®¡ç†å‘˜ç™»å½•</h3>
            <el-form inline>
                <el-form-item><el-input v-model="loginForm.username" placeholder="è´¦å·"></el-input></el-form-item>
                <el-form-item><el-input v-model="loginForm.password" type="password" placeholder="å¯†ç "></el-input></el-form-item>
                <el-form-item><el-button type="primary" @click="handleLogin">ç™»å½•</el-button></el-form-item>
            </el-form>
        </div>

        <div v-else>
            <div class="step">
                <h3>2. å®‰å…¨è¿‡æ»¤è®¾ç½® <span style="color:#F56C6C; font-size:14px;">(å…³é”®æ­¥éª¤)</span></h3>
                <el-form label-width="120px">
                    <el-form-item label="é™åˆ¶å•†å“åˆ†ç±»">
                        <el-input v-model="targetCategory" placeholder="ä¾‹å¦‚ï¼šè†œ" style="width: 200px;"></el-input>
                        <span style="color:#666; font-size:12px; margin-left:10px;">
                            (é‡è¦ï¼šå¡«â€œè†œâ€åˆ™åªæ›´æ–°é’¢åŒ–è†œï¼Œå¡«â€œå£³â€åªæ›´æ–°æ‰‹æœºå£³ã€‚ä¸å¡«åˆ™å…¨éƒ¨æ›´æ–°)
                        </span>
                    </el-form-item>
                    <el-form-item label="åŒ¹é…æ¨¡å¼">
                        <el-radio-group v-model="matchMode">
                            <el-radio label="strict">ç²¾ç¡®åŒ¹é… (æ¨è)</el-radio>
                            <el-radio label="fuzzy" disabled>æ¨¡ç³ŠåŒ¹é… (å·²ç¦ç”¨ä»¥ä¿å®‰å…¨)</el-radio>
                        </el-radio-group>
                        <div style="font-size:12px; color:#999; line-height:1.5;">
                            * ç²¾ç¡®åŒ¹é…ï¼šå¿½ç•¥å¤§å°å†™ï¼Œä½†å­—ç¬¦å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚<br>
                            ä¾‹å¦‚ Excelå¡« "X23"ï¼Œèƒ½åŒ¹é… "vivo X23"ï¼Œä½†<b>ä¸ä¼š</b>åŒ¹é… "X23å¹»å½©ç‰ˆ"ã€‚
                        </div>
                    </el-form-item>
                </el-form>
            </div>

            <div class="step">
                <h3>3. Excel æ ¼å¼è¦æ±‚</h3>
                <p style="font-size:14px; color:#666;">Excel éœ€è¦æœ‰è¡¨å¤´(ç¬¬ä¸€è¡Œ)ï¼Œæ•°æ®ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼š</p>
                <table class="excel-demo">
                    <tr><th width="100">Aåˆ— (å“ç‰Œ)</th><th width="100">Båˆ— (å‹å·)</th><th>Cåˆ— (é€šç”¨ç»„ID)</th></tr>
                    <tr><td>VIVO</td><td>X23</td><td>1</td></tr>
                    <tr><td>åä¸º</td><td>NOVA5</td><td>1</td></tr>
                    <tr><td>OPPO</td><td>R17</td><td>1</td></tr>
                    <tr><td>...</td><td>...</td><td>...</td></tr>
                </table>
            </div>

            <div class="step" style="border-bottom:none;">
                <h3>4. ä¸Šä¼ å¹¶åˆ†æ</h3>
                <div style="display:flex; gap: 10px; align-items:center; margin-bottom: 15px;">
                    <el-upload action="#" :auto-upload="false" :show-file-list="false" :on-change="handleFile" accept=".xlsx, .xls">
                        <el-button type="primary" size="large" icon="FolderOpened">é€‰æ‹© Excel æ–‡ä»¶</el-button>
                    </el-upload>
                    <div v-if="processing"><i class="el-icon-loading"></i> æ•°æ®åˆ†æä¸­...</div>
                </div>

                <div v-if="logs.length > 0">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>æ‰§è¡Œæ—¥å¿—ï¼š</strong>
                        <el-button v-if="readyToUpdate" type="success" size="default" @click="confirmUpdate">
                            ç¡®è®¤æ— è¯¯ï¼Œæ›´æ–° {{ updateQueue.length }} ä¸ªå•†å“
                        </el-button>
                    </div>
                    <div class="log-box" ref="logBox">
                        <div v-for="(log, i) in logs" :key="i" :class="'log-'+log.type">
                            <span style="opacity:0.5;">[{{ log.time }}]</span> {{ log.msg }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, nextTick } = Vue;
    const API_URL = './api.php';

    createApp({
        setup() {
            const currentUser = ref(null);
            const loginForm = ref({username:'', password:''});
            const targetCategory = ref('è†œ'); // é»˜è®¤åªæ›´æ–°è†œ
            const matchMode = ref('strict');

            const logs = ref([]);
            const logBox = ref(null);
            const processing = ref(false);
            const readyToUpdate = ref(false);
            const updateQueue = ref([]);

            const addLog = (type, msg) => {
                const time = new Date().toLocaleTimeString('en-GB');
                logs.value.push({ type, msg, time });
                nextTick(() => { if(logBox.value) logBox.value.scrollTop = logBox.value.scrollHeight; });
            };

            const handleLogin = async () => {
                try {
                    const res = await axios.post(`${API_URL}?action=login`, loginForm.value);
                    if (res.data.status === 'success') {
                        currentUser.value = res.data.data;
                        addLog('success', `ç™»å½•æˆåŠŸ: ${currentUser.value.real_name}`);
                    } else alert(res.data.message);
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
            };

            const handleFile = (file) => {
                logs.value = [];
                updateQueue.value = [];
                readyToUpdate.value = false;
                processing.value = true;

                addLog('info', `å‡†å¤‡è¯»å–æ–‡ä»¶... è¿‡æ»¤æ¡ä»¶: [åˆ†ç±»åŒ…å« "${targetCategory.value}"]`);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // 1. è¯»å– Excel
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {type: 'array'});
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});

                        if (rows.length < 2) {
                            addLog('error', 'Excel æ•°æ®ä¸ºç©ºæˆ–ç¼ºå°‘è¡¨å¤´ï¼');
                            return;
                        }

                        // 2. è·å–æ•°æ®åº“åº“å­˜
                        addLog('info', 'æ­£åœ¨ä¸‹è½½æœ€æ–°åº“å­˜æ•°æ®...');
                        const res = await axios.get(`${API_URL}?action=products`);
                        const allProducts = res.data.data || [];
                        addLog('info', `åº“å­˜å…± ${allProducts.length} ä¸ªå•†å“ã€‚`);

                        // 3. æ•´ç† Excel æ•°æ® (æŒ‰ Cåˆ— ç»„ID åˆ†ç»„)
                        const groups = {};
                        let validExcelRows = 0;
                        rows.forEach((row, idx) => {
                            if (idx === 0) return; // è·³è¿‡è¡¨å¤´
                            const brand = String(row[0]||'').trim();
                            const model = String(row[1]||'').trim();
                            const gid = String(row[2]||'').trim();
                            if(brand && model && gid) {
                                if(!groups[gid]) groups[gid] = [];
                                groups[gid].push({brand, model});
                                validExcelRows++;
                            }
                        });
                        addLog('info', `è¯†åˆ«åˆ° ${Object.keys(groups).length} ä¸ªé€šç”¨ç»„ï¼Œå…± ${validExcelRows} è¡Œæœ‰æ•ˆæ•°æ®ã€‚`);

                        // 4. åŒ¹é…ä¸è¿‡æ»¤
                        let matchCount = 0;
                        let skipCount = 0; // å› åˆ†ç±»ä¸ç¬¦è·³è¿‡
                        let notFoundCount = 0; // å› å‹å·æ²¡æ‰¾åˆ°è·³è¿‡

                        for (const [gid, items] of Object.entries(groups)) {
                            // ç”Ÿæˆå¤‡æ³¨å­—ç¬¦ä¸²ï¼š X23 / Nova5 / ...
                            const uniqueModels = [...new Set(items.map(i => i.model))];
                            const remarkStr = uniqueModels.join(' / ');

                            addLog('info', `--- åˆ†æé€šç”¨ç»„ ${gid} (åŒ…å«: ${remarkStr}) ---`);

                            items.forEach(excelItem => {
                                // åœ¨åº“å­˜é‡Œæ‰¾è¿™ä¸ªå‹å·
                                // é€»è¾‘ï¼šå“ç‰Œ+å‹å·åŒ¹é… (å¿½ç•¥å¤§å°å†™)
                                const targets = allProducts.filter(p =>
                                    p.brand.trim().toUpperCase() === excelItem.brand.toUpperCase() &&
                                    p.model.trim().toUpperCase() === excelItem.model.toUpperCase()
                                );

                                if (targets.length === 0) {
                                    addLog('warn', `æœªæ‰¾åˆ°å•†å“: ${excelItem.brand} - ${excelItem.model}`);
                                    notFoundCount++;
                                } else {
                                    // æ‰¾åˆ°äº†å•†å“ï¼Œç°åœ¨æ£€æŸ¥â€œç±»å‹è¿‡æ»¤â€
                                    targets.forEach(target => {
                                        // æ£€æŸ¥ accessory_type æ˜¯å¦åŒ…å«ç”¨æˆ·è¾“å…¥çš„å…³é”®è¯ (å¦‚ "è†œ")
                                        const currentType = String(target.accessory_type || '');
                                        const filterKey = targetCategory.value.trim();

                                        if (filterKey && !currentType.includes(filterKey)) {
                                            // ç±»å‹ä¸ç¬¦ï¼Œè·³è¿‡
                                            addLog('info', `è·³è¿‡: ${target.model} (ç±»å‹æ˜¯"${currentType}"ï¼Œä¸å«"${filterKey}")`);
                                            skipCount++;
                                        } else {
                                            // ç±»å‹ç¬¦åˆï¼ŒåŠ å…¥æ›´æ–°é˜Ÿåˆ—
                                            updateQueue.value.push({
                                                ...target,
                                                remark: remarkStr // æ›´æ–°å¤‡æ³¨
                                            });
                                            addLog('success', `âœ… åŒ¹é…: [${target.brand} ${target.model}] (${currentType}) -> å¾…æ›´æ–°`);
                                            matchCount++;
                                        }
                                    });
                                }
                            });
                        }

                        addLog('info', `åˆ†æå®Œæˆã€‚å¾…æ›´æ–°: ${matchCount} ä¸ªã€‚è·³è¿‡(ç±»å‹ä¸ç¬¦): ${skipCount} ä¸ªã€‚æœªæ‰¾åˆ°: ${notFoundCount} ä¸ªã€‚`);
                        if(matchCount > 0) readyToUpdate.value = true;

                    } catch (err) {
                        console.error(err);
                        addLog('error', 'å¤„ç†å‡ºé”™: ' + err.message);
                    } finally {
                        processing.value = false;
                    }
                };
                reader.readAsArrayBuffer(file.raw);
            };

            const confirmUpdate = async () => {
                if (!confirm(`å³å°†æ›´æ–° ${updateQueue.value.length} ä¸ªå•†å“çš„å¤‡æ³¨ï¼Œç¡®å®šå—ï¼Ÿ`)) return;

                processing.value = true;
                let success = 0;
                for (const item of updateQueue.value) {
                    try {
                        await axios.post(`${API_URL}?action=update_product`, {
                            ...item,
                            user_id: currentUser.value.id
                        });
                        success++;
                    } catch(e) {}
                }
                processing.value = false;
                readyToUpdate.value = false;
                addLog('success', `ğŸ‰ å…¨éƒ¨å®Œæˆï¼æˆåŠŸæ›´æ–° ${success} æ¡æ•°æ®ã€‚`);
                alert('æ›´æ–°æˆåŠŸï¼');
            };

            return {
                currentUser, loginForm, handleLogin,
                targetCategory, matchMode,
                logs, logBox, handleFile, processing,
                readyToUpdate, updateQueue, confirmUpdate
            };
        }
    }).use(ElementPlus).mount('#app');
</script>
</body>
</html>